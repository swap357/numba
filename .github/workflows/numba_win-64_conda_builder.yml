name: numba_win-64_conda_builder

on:
  pull_request:
    paths:
      - .github/workflows/numba_win-64_conda_builder.yml
      - .github/actions/**
      - buildscripts/condarecipe.local/**
      - buildscripts/github/conda_evaluate.py
      - buildscripts/github/workflow_config.py
  workflow_dispatch:
    inputs:
      llvmlite_run_id:
        description: 'llvmlite workflow run ID (optional)'
        required: false
        type: string

# Add concurrency control
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

jobs:
  load-matrix:
    runs-on: ubuntu-latest
    outputs:
      build-matrix-json: ${{ steps.evaluate.outputs.build-matrix-json }}
      test-matrix-json: ${{ steps.evaluate.outputs.test-matrix-json }}
      config-json: ${{ steps.evaluate.outputs.config-json }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6.0.0
        with:
          python-version: '3.14'
      - name: Evaluate
        id: evaluate
        env:
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_WORKFLOW_INPUT: ${{ toJson(github.event.inputs) }}
          GITHUB_PLATFORM: win-64
        run: |
          set -ex
          echo "=== Environment ==="
          echo "Event: $GITHUB_EVENT_NAME"
          echo "Inputs: $GITHUB_WORKFLOW_INPUT"
          echo "Platform: $GITHUB_PLATFORM"
          echo "=== Running evaluation script ==="
          ./buildscripts/github/conda_evaluate.py
          echo "=== Evaluation completed ==="

  win-64-build-conda:
    name: win-64-build-conda (py ${{ matrix.python-version }}, np ${{ matrix.numpy_build }})
    needs: load-matrix
    runs-on: ${{ fromJson(needs.load-matrix.outputs.config-json).runner }}
    defaults:
      run:
        shell: bash -elx {0}
    strategy:
      matrix:
        include: ${{ fromJson(needs.load-matrix.outputs.build-matrix-json) }}
      fail-fast: false

    steps:
      - name: Clone repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Setup Conda Environment
        uses: ./.github/actions/setup-conda-env
        with:
          platform: ${{ matrix.platform }}
          python-version: ${{ fromJson(needs.load-matrix.outputs.config-json).conda_setup_python_version }}

      - name: Download llvmlite Artifact
        uses: ./.github/actions/download-llvmlite-conda
        with:
          llvmlite-run-id: ${{ inputs.llvmlite_run_id }}
          platform: ${{ matrix.platform }}
          python-version: ${{ matrix.python-version }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install conda-build
        uses: ./.github/actions/install-conda-build
        with:
          platform: ${{ matrix.platform }}

      - name: Build Numba conda package
        uses: ./.github/actions/build-conda
        with:
          platform: ${{ matrix.platform }}
          python-version: ${{ matrix.python-version }}
          numpy-build: ${{ matrix.numpy_build }}
          llvmlite-run-id: ${{ inputs.llvmlite_run_id }}
          conda-channel-numba: ${{ fromJson(needs.load-matrix.outputs.config-json).conda_channel_numba }}
          extra-channels: ${{ matrix.extra_channels }}

      - name: Upload numba conda package
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: numba_${{ matrix.platform }}_conda_py${{ matrix.python-version }}
          path: conda_channel_dir
          compression-level: 0
          retention-days: ${{ fromJson(needs.load-matrix.outputs.config-json).artifact_retention_days }}
          if-no-files-found: error

  win-64-test-conda:
    name: win-64-test-conda (py ${{ matrix.python-version }}, np ${{ matrix.numpy_test }})
    needs: [load-matrix, win-64-build-conda]
    runs-on: ${{ fromJson(needs.load-matrix.outputs.config-json).runner }}
    defaults:
      run:
        shell: bash -elx {0}
    strategy:
      matrix:
        include: ${{ fromJson(needs.load-matrix.outputs.test-matrix-json) }}
      fail-fast: false

    steps:
      - name: Clone repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Setup Conda Environment
        uses: ./.github/actions/setup-conda-env
        with:
          platform: ${{ matrix.platform }}
          python-version: ${{ fromJson(needs.load-matrix.outputs.config-json).conda_setup_python_version }}

      - name: Install conda-build
        uses: ./.github/actions/install-conda-build
        with:
          platform: ${{ matrix.platform }}

      - name: Test Numba conda package
        uses: ./.github/actions/test-conda
        with:
          platform: ${{ matrix.platform }}
          python-version: ${{ matrix.python-version }}
          numpy-test: ${{ matrix.numpy_test }}
          llvmlite-run-id: ${{ inputs.llvmlite_run_id }}
          conda-channel-numba: ${{ fromJson(needs.load-matrix.outputs.config-json).conda_channel_numba }}
          extra-channels: ${{ matrix.extra_channels }}
          numba-artifact-name: numba_${{ matrix.platform }}_conda_py${{ matrix.python-version }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
